---
title: Azure 前门-流量路由方法 |Microsoft Docs
description: 本文帮助你了解 Front Door 使用的不同流量路由方法
services: front-door
documentationcenter: ''
author: duongau
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/28/2020
ms.author: duau
ms.openlocfilehash: 2bc056620ff964747dfd83e7525cb5bfd2eb8e52
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/09/2020
ms.locfileid: "91449148"
---
# <a name="front-door-routing-methods"></a>Front Door 路由方法

Azure 前门支持不同类型的流量路由方法，以确定如何将 HTTP/HTTPS 流量路由到不同的服务终结点。 当客户端请求到达前门时，将应用配置的路由方法，以确保将请求转发到最佳后端实例。 

前门提供了四种流量路由方法：

* **[延迟](#latency)：** 基于延迟的路由确保将请求发送到在敏感度范围内可接受的最低延迟的后端。 基本上，用户请求将发送到 "最近" 的后端集，这与网络延迟有关。
* **[优先级](#priority)：** 如果要将主后端配置为服务所有流量，则可以将优先级分配给后端。 辅助后端可以为备份，以防主后端不可用。
* **[加权](#weighted)：** 如果要将流量分配到一组后端，可以为后端分配权重。 是要均匀分配还是根据权重系数。
* **[会话相关性](#affinity)：** 你可以为前端主机或域配置会话相关性，以确保将同一最终用户发出的请求发送到相同的后端。

所有 Front Door 配置包括后端运行状况的监视，以及自动化的即时全局故障转移。 有关详细信息，请参阅 [Front Door 后端监视](front-door-health-probes.md)。 您的前门可以基于单一路由方法工作。 但根据应用程序的需要，你还可以结合使用多种路由方法来构建最佳路由拓扑。

## <a name="lowest-latencies-based-traffic-routing"></a><a name = "latency"></a>基于最低延迟的流量路由

在全球两个或更多位置部署后端可以通过将流量路由到与最终用户最接近的目标来改善应用程序的响应能力。 前门配置的默认流量路由方法会将最终用户的请求转发到收到请求的前端环境最近的后端。 此方法与 Azure 前门的任意播结构相结合，可确保每个最终用户根据其位置获得最大的个性化性能。

"最近的" 后端不一定是按地理距离衡量的最接近的后端。 Front Door 通过测量网络延迟来确定最靠近的后端。 详细了解 [Front Door 的路由体系结构](front-door-routing-architecture.md)。 

下面是整体决策流：

| 可用后端 | 优先度 | 延迟信号（基于运行状况探测） | 权重 |
|-------------| ----------- | ----------- | ----------- |
| 首先，选择已启用并返回运行状况探测 (200 正常) 的所有后端。 如果有六个后端 A、B、C、D、E 和 F，其中 C 不正常，并且禁用了 E。 可用的后端列表为 A、B、D 和 F。  | 接下来，选择可用选项中的顶级优先级后端。 如果后端 A、B 和 D 的优先级为1，而后端 F 的优先级为2。 然后，所选后端将为 A、B 和 D。| 选择在延迟范围内的后端（最小延迟，根据以毫秒为单位指定的延迟敏感度确定）。 如果后端 A 是15毫秒，则 B 为30毫秒，而 D 60 ms 离开前门环境（其中，请求着陆和延迟敏感度为 30 ms），最小延迟池包含后端 A 和 B，因为 D 超出最近的后端。 | 最后，Front Door 将会根据指定的权重比，在最终选择的后端池之间轮循流量。 假设后端 A 的权重为 5，后端 B 的权重为 8，则流量将按 5:8 的比在后端 A 与 B 之间分配。 |

>[!NOTE]
> 默认情况下，延迟敏感度属性设置为 0 毫秒，即，始终将请求转发到最快的可用后端。

## <a name="priority-based-traffic-routing"></a><a name = "priority"></a>基于优先级的流量路由

通常，组织希望通过在主服务器出现故障时部署多个备份服务来为其服务提供高可用性。 在整个行业中，此拓扑也称为“主动/后备”或“主动/被动”部署拓扑。 Azure 客户可以通过“优先级”流量路由方法来轻松实现此故障转移模式。

默认的 Front Door 包含后端的均等优先级列表。 默认情况下，Front Door 只将流量发送到最高优先级后端（优先级值最小），即主要后端集。 如果主后端不可用，前门会将流量路由到后端的辅助集 (第二个最低值为优先级) 。 如果主要和辅助后端都不可用，则流量将转到第三个，依此类推。 后端可用性基于配置的状态（已启用或已禁用），持续的后端运行状况由运行状况探测确定。

### <a name="configuring-priority-for-backends"></a>配置后端的优先级

前端配置的后端池中的每个后端都有一个名为 "Priority" 的属性，它可以是介于1和5之间的数字。 使用 Azure 前门，你可以使用此属性为每个后端显式配置后端优先级。 此属性是介于 1 和 5 之间的值。 值越小，优先级越高。 后端可以共享优先级值。

## <a name="weighted-traffic-routing-method"></a><a name = "weighted"></a>加权流量路由方法
使用“加权”流量路由方法可以均匀分布流量，或使用预定义的权重。

在加权流量路由方法中，需将一个权重分配到后端池的 Front Door 配置中的每个后端。 该权重是从 1 到 1000 的整数。 此参数使用默认权重“50”。

使用具有可接受的延迟敏感度的可用后端的列表，流量将使用指定权重的比率与循环机制一起分发。 如果延迟敏感性设置为0毫秒，则除非有两个后端具有相同网络延迟，否则此属性不会生效。 

加权方法可以实现一些有用的方案：

* **逐步应用程序升级**：提供路由到新后端的流量百分比，并随着时间的推移逐渐增加流量，使其与其他后端。
* **将应用程序迁移到 Azure**：创建包含 Azure 后端和外部后端的后端池。 调整后端权重，以优先选择新的后端。 可以采用渐进式的设置方式：一开始禁用新后端，然后为它们分配最低权重，再慢慢地将权重提高到接收最多流量的级别。 最后，禁用优先级最低的后端，并从池中删除它们。  
* **执行云喷发式部署以增加容量**：通过将本地部署放在 Front Door 的后面，快速将其扩展到云中。 需要在云中获取更多的容量时，可以添加或启用更多后端，并指定哪部分流量将流向每个后端。

## <a name="session-affinity"></a><a name = "affinity"></a>会话相关性
默认情况下，如果没有会话相关性，前门会将来自同一客户端的请求转发到不同的后端。 有些有状态应用程序，或在某些情况下，来自同一用户的请求将更喜欢处理初始请求的相同后端。 需要在同一后端上保留用户会话时，基于 Cookie 的会话关联功能非常有用。 使用托管 cookie，Azure 前门可以将来自用户会话的后续流量定向到同一后端进行处理。

可以在配置的每个域（或子域）的前端主机级别启用会话关联。 启用后，Front Door 会将一个 Cookie 添加到用户的会话。 基于 Cookie 的会话关联可让 Front Door 识别不同的用户（即使他们使用相同的 IP 地址），而这又可以在不同的后端之间更均匀地分配流量。

Cookie 的生存期与用户会话相同，因为 Front Door 目前仅支持会话 Cookie。 

> [!NOTE]
> 公共代理可能会干扰会话关联。 这是因为，建立会话需要 Front Door 将会话关联 Cookie 添加到响应中，而如果响应可缓存，则无法做到这一点，因为这样可能会中断请求同一资源的其他客户端的 Cookie。 为防止此问题，如果后端发送可缓存的响应，则**不会**建立会话关联。 如果已建立会话，则来自后端的响应是否可缓存并不重要。
> **除非**响应中包含 HTTP 304 状态代码，否则，在以下情况下会建立会话关联：
> - 响应具有为标头设置的特定值，用于 ```Cache-Control``` 阻止缓存，如 "专用" 或 "非商店"。
> - 响应中包含未过期的 ```Authorization``` 标头。
> - 响应中包含 HTTP 302 状态代码。

## <a name="next-steps"></a>后续步骤

- 了解如何[创建 Front Door](quickstart-create-front-door.md)。
- 了解 [Front Door 的工作原理](front-door-routing-architecture.md)。
