---
title: Azure Database for PostgreSQL-灵活服务器中的备份和还原
description: 了解 Azure Database for PostgreSQL-灵活服务器的备份和还原的概念
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: d0e79e42c7c004638336ada23de663bbe74b7e48
ms.sourcegitcommit: d767156543e16e816fc8a0c3777f033d649ffd3c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/26/2020
ms.locfileid: "92532639"
---
# <a name="backup-and-restore-in-azure-database-for-postgresql---flexible-server"></a>Azure Database for PostgreSQL-灵活服务器中的备份和还原

> [!IMPORTANT]
> Azure Database for PostgreSQL 灵活服务器以预览版提供

备份构成了任何业务连续性策略的重要组成部分。 它们有助于保护数据不被意外损坏或删除。 Azure Database for PostgreSQL 灵活的服务器自动备份服务器，并将备份保留最多35天。 在还原过程中，可以指定要在保持期内还原到的日期和时间。 还原和恢复的总时间取决于数据库文件的大小和要执行的恢复量。 

### <a name="backup-process-in-flexible-server"></a>灵活服务器中的备份过程
第一次快照备份在创建灵活服务器后立即进行计划。 然后，执行数据文件的每日快照备份。 备份存储在区域内的区域冗余存储中。 事务日志 (写提前日志-WAL) 也会连续存档，以便能够还原到上次提交的事务。 可以通过这些数据和日志备份将服务器还原到所配置的备份保留期中的任意时间点。 所有备份都使用 AES 256 位加密进行加密。

如果数据库配置了高可用性，则会从主副本执行每日快照，并从备用执行连续日志备份。

> [!IMPORTANT]
>不会在已停止的服务器上执行备份。 但是，当数据库在7天后自动启动或用户启动后，备份会恢复。

备份仅可用于在灵活服务器中执行的还原操作。 如果要将数据导出或导入到灵活的服务器，请使用 [转储和还原](../howto-migrate-using-dump-and-restore.md) 方法。


### <a name="backup-retention"></a>备份保留期

根据服务器的 "备份保留期" 设置保留备份。 你可以选择7到35天之间的保留期。 默认保持期为七天。 可以在服务器创建过程中设置保留期，也可以在以后更新。 即使已停止的服务器也会保留备份。

备份保留期控制可检索时间点还原的时间，因为它 \' 基于可用的备份。 从恢复的角度来看，备份保留期也可以视为恢复时段。 备份保留期内执行时间点还原所需的所有备份将保留在备份存储中。 例如，如果备份保持期设置为七天，则会将恢复时段视为最后七天。 在这种情况下，将保留在过去7天内还原和恢复服务器所需的所有数据和日志。 


### <a name="backup-storage-cost"></a>备份存储成本

灵活的服务器最多可提供100% 的预配服务器存储作为备份存储，无需额外付费。 超出的备份存储使用量按每月每 GB 标准收费。 例如，如果你预配了具有 250 GiB 的存储的服务器，则会有 250 GiB 的备份存储容量，无需额外付费。 如果每日备份使用量为 25 GiB，则最多可以有10天的免费备份存储空间。 超过 250 GiB 的备份存储消耗按 [定价模式](https://azure.microsoft.com/pricing/details/postgresql/)收费。

可使用 Azure 门户中的“已使用的备份存储”指标来监视服务器占用的备份存储。 “已使用的备份存储”指标表示根据为服务器设置的备份保留期保留的所有数据库备份和日志备份占用的存储总和。  无论数据库的总大小如何，如果服务器上的事务性活动繁重，都会导致备份存储使用率增加。

控制备份存储成本的主要方法是设置适当的备份保留期，并选择正确的备份冗余选项以满足恢复目标。

> [!IMPORTANT]
> 灵活的服务器当前不支持异地冗余备份。

## <a name="point-in-time-restore-overview"></a>时间点还原概述

在灵活的服务器中，执行时间点还原将从与 \' 源服务器相同的区域中的灵活服务器备份创建新服务器。 它是通过源服务器的配置为定价层、计算生成、Vcore 数、存储大小、备份保留期和备份冗余选项创建的。 此外，还会从源服务器继承标记和设置，例如 VNET 和防火墙设置。 

 > [!IMPORTANT]
> 如果要还原配置了区域冗余高可用性的灵活服务器，则会在与主服务器相同的区域中配置还原后的服务器。 

 ### <a name="restore-process"></a>还原过程

首先，将物理数据库文件从快照备份还原到服务器的数据位置。 将自动选择并还原早于所需时间点的相应备份。 然后，使用 WAL 文件启动恢复过程，使数据库处于一致状态。 

 例如，假设每晚在晚上11点执行备份。 如果还原点适用于8月15日，2020 10:00 am，则将还原每日8月 2020 14 日的备份。 在2020年8月25日之间使用事务日志备份，将恢复该数据库，直到8月25日，10am 到10am。 

 请参阅 [以下步骤](./how-to-restore-server-portal.md) 来还原数据库服务器。

> [!IMPORTANT]
> 灵活服务器中的还原操作会创建新的数据库服务器，并且不会覆盖现有的数据库服务器。

多种情况下可以使用时间点还原。 例如，用户意外删除了数据、删除了重要的表或数据库，或者应用程序因为缺陷而意外地使用错误数据覆盖了正确数据。 由于事务日志的持续备份，你将能够还原到最后一个事务。

可以在最早的还原点和自定义的还原点之间进行选择。

-   **最早还原点** ：根据你的保留期，它将是你可以还原的最早时间。 最早的备份时间将自动选择，并显示在门户上。 如果您想要调查或在一定时间点开始测试，这会很有用。

-   **自定义还原点** ：此选项允许您在为此灵活服务器定义的保留期内选择任何时间点。 默认情况下，UTC 中的最晚时间是自动选择的，如果要还原到上次提交的事务进行测试，则会很有用。 您可以选择其他日期和时间。 

估计恢复时间取决于多个因素，包括数据库大小、要处理的事务日志量、网络带宽，以及同时在同一区域中恢复的数据库总数。 整个恢复时间通常需要几分钟到几小时。


> [!IMPORTANT]
> 已删除的服务器 **无法** 还原。 如果删除服务器，则属于该服务器的所有数据库也会被删除且不可恢复。 为了防止服务器资源在部署后遭意外删除或意外更改，管理员可以利用[管理锁](../../azure-resource-manager/management/lock-resources.md)。

## <a name="perform-post-restore-tasks"></a>执行还原后任务

还原数据库后，您可以执行以下任务，以使您的用户和应用程序恢复正常运行：

-   如果新服务器打算替换原始服务器，请将客户端和客户端应用程序重定向到新服务器。

-   对于要进行连接的用户，请确保设置适当的服务器级防火墙规则和 VNet 规则。 不会从源服务器复制这些规则。
  
-   还原的服务器的计算可以根据需要进行扩展/缩减。

-   确保设置适当的登录名和数据库级别权限。

-   视情况配置警报。
  
-  如果已还原配置为具有高可用性的数据库，并且想要配置具有高可用性的已还原服务器，则可以按照 [步骤](./how-to-manage-high-availability-portal.md)进行操作。


## <a name="next-steps"></a>后续步骤

-   了解 [业务连续性](./concepts-business-continuity.md)
-   了解 [区域冗余高可用性](./concepts-high-availability.md)
-   了解 [如何还原](./how-to-restore-server-portal.md)